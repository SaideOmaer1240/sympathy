Para implementar a funcionalidade de filtrar todos os pedidos de consulta e adicionar a opção de aceitar ou recusar um pedido, seguido da criação de uma agenda, você pode seguir o seguinte fluxo:

1. **Listar todos os pedidos pendentes**: Mostrar todos os pedidos de consulta com status "pendente".
2. **Aceitar ou recusar um pedido**: Implementar ações para aceitar ou recusar o pedido.
3. **Criar uma agenda automaticamente ao aceitar**: Se o pedido for aceito, permitir que o consultor crie uma agenda relacionada ao pedido.

Aqui está uma sugestão de como você pode implementar isso no seu código:

### 1. Função para listar todos os pedidos pendentes

```python
from db.models import Pedido, Consultor, Session
from fasthtml.common import Titled, Tr, Td, Button, Table, Thead, Tbody, Th

async def listar_pedidos(req):
    session = Session()
    consultor_email = req.state.user["sub"]  # Email do consultor logado, extraído do token

    # Buscar o consultor logado
    consultor = session.query(Consultor).filter(Consultor.email == consultor_email).first()
    if not consultor:
        session.close()
        return Titled("Erro", P("Consultor não encontrado."))

    # Buscar todos os pedidos pendentes para esse consultor
    pedidos = session.query(Pedido).filter(Pedido.consultor_id == consultor.id, Pedido.status == "pendente").all()
    
    if not pedidos:
        session.close()
        return Titled("Pedidos de Consultoria", P("Nenhum pedido pendente encontrado."))

    # Construir a tabela de pedidos com botões para aceitar ou recusar
    pedido_rows = [
        Tr(
            Td(f"Cliente: {p.cliente.nome}"),  # Nome do cliente
            Td(f"Data: {p.created_at}"),  # Data do pedido
            Td(Button("Aceitar", onclick=f"window.location.href='/aceitar_pedido/{p.id}'")),
            Td(Button("Recusar", onclick=f"window.location.href='/recusar_pedido/{p.id}'"))
        ) for p in pedidos
    ]

    session.close()

    return Titled("Pedidos de Consultoria",
        Table(
            Thead(
                Tr(Th("Cliente"), Th("Data"), Th("Aceitar"), Th("Recusar"))
            ),
            Tbody(*pedido_rows)
        )
    )
```

### 2. Função para aceitar um pedido e criar uma agenda

```python
from db.models import Pedido, Agenda
from starlette.responses import JSONResponse
from datetime import datetime, timezone

async def aceitar_pedido(req, pedido_id: int):
    session = Session()
    consultor_email = req.state.user["sub"]  # Email do consultor logado, extraído do token

    try:
        # Buscar o consultor logado
        consultor = session.query(Consultor).filter(Consultor.email == consultor_email).first()
        if not consultor:
            session.close()
            return JSONResponse(content={"message": "Consultor não encontrado."}, status_code=404)

        # Buscar o pedido de consultoria
        pedido = session.query(Pedido).filter(Pedido.id == pedido_id, Pedido.consultor_id == consultor.id).first()
        if not pedido:
            session.close()
            return JSONResponse(content={"message": "Pedido não encontrado."}, status_code=404)

        # Atualizar o status do pedido para "aceito"
        pedido.status = "aceito"
        session.commit()

        # Criar uma agenda para esse pedido
        nova_agenda = Agenda(
            pedido_id=pedido.id,
            assunto=f"Consulta com {pedido.cliente.nome}",  # Assunto padrão
            data=datetime.now(timezone.utc).date(),  # Data atual
            horario=datetime.now(timezone.utc).time(),  # Horário atual
            created_at=datetime.now(timezone.utc),
        )
        session.add(nova_agenda)
        session.commit()

        return JSONResponse(content={"message": "Pedido aceito e agenda criada com sucesso!"}, status_code=200)

    except Exception as e:
        session.rollback()
        return JSONResponse(content={"message": f"Erro ao aceitar pedido: {str(e)}"}, status_code=500)
    
    finally:
        session.close()
```

### 3. Função para recusar um pedido

```python
async def recusar_pedido(req, pedido_id: int):
    session = Session()
    consultor_email = req.state.user["sub"]  # Email do consultor logado, extraído do token

    try:
        # Buscar o consultor logado
        consultor = session.query(Consultor).filter(Consultor.email == consultor_email).first()
        if not consultor:
            session.close()
            return JSONResponse(content={"message": "Consultor não encontrado."}, status_code=404)

        # Buscar o pedido de consultoria
        pedido = session.query(Pedido).filter(Pedido.id == pedido_id, Pedido.consultor_id == consultor.id).first()
        if not pedido:
            session.close()
            return JSONResponse(content={"message": "Pedido não encontrado."}, status_code=404)

        # Atualizar o status do pedido para "recusado"
        pedido.status = "recusado"
        session.commit()

        return JSONResponse(content={"message": "Pedido recusado com sucesso!"}, status_code=200)

    except Exception as e:
        session.rollback()
        return JSONResponse(content={"message": f"Erro ao recusar pedido: {str(e)}"}, status_code=500)
    
    finally:
        session.close()
```

### 4. Rotas

Adicione as seguintes rotas para permitir que as funções sejam chamadas:

```python
# Rota para listar pedidos pendentes
@rt("/listar_pedidos", methods=["GET"])
@autenticar(role='consultor')
async def rota_listar_pedidos(req):
    return await listar_pedidos(req)

# Rota para aceitar um pedido
@rt("/aceitar_pedido/{pedido_id}", methods=["GET"])
@autenticar(role='consultor')
async def rota_aceitar_pedido(req, pedido_id: int):
    return await aceitar_pedido(req, pedido_id)

# Rota para recusar um pedido
@rt("/recusar_pedido/{pedido_id}", methods=["GET"])
@autenticar(role='consultor')
async def rota_recusar_pedido(req, pedido_id: int):
    return await recusar_pedido(req, pedido_id)
```

### Explicação

- **Listar Pedidos**: Exibe uma tabela com todos os pedidos pendentes para o consultor logado.
- **Aceitar Pedido**: Atualiza o status do pedido para "aceito" e cria automaticamente uma agenda associada ao pedido.
- **Recusar Pedido**: Atualiza o status do pedido para "recusado".

Essas funções podem ser ajustadas conforme suas necessidades para expandir as funcionalidades da sua plataforma de consultoria.